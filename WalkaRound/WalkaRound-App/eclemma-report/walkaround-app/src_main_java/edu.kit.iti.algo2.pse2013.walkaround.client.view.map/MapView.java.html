<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>MapView.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">walkaround-tests (16.08.2013 02:31:21)</a> &gt; <a href="../../index.html" class="el_group">walkaround-app</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.html" class="el_package">edu.kit.iti.algo2.pse2013.walkaround.client.view.map</a> &gt; <span class="el_source">MapView.java</span></div><h1>MapView.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">package edu.kit.iti.algo2.pse2013.walkaround.client.view.map;</span>

// Java Library
import java.util.List;

import android.animation.Animator;
import android.animation.Animator.AnimatorListener;
import android.animation.AnimatorSet;
import android.animation.ObjectAnimator;
import android.app.Activity;
import android.app.Fragment;
import android.app.FragmentTransaction;
import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.Point;
import android.graphics.Rect;
import android.graphics.drawable.Drawable;
import android.os.Bundle;
import android.util.Log;
import android.view.Display;
import android.view.GestureDetector;
import android.view.GestureDetector.OnGestureListener;
import android.view.MotionEvent;
import android.view.View;
import android.view.View.OnTouchListener;
import android.view.ViewGroup.LayoutParams;
import android.widget.ImageView;
import android.widget.RelativeLayout;
import edu.kit.iti.algo2.pse2013.walkaround.client.R;
import edu.kit.iti.algo2.pse2013.walkaround.client.controller.map.MapController;
import edu.kit.iti.algo2.pse2013.walkaround.client.model.map.DisplayPOI;
import edu.kit.iti.algo2.pse2013.walkaround.client.model.map.DisplayWaypoint;
import edu.kit.iti.algo2.pse2013.walkaround.client.model.util.TextToSpeechUtility;
import edu.kit.iti.algo2.pse2013.walkaround.client.view.headup.HeadUpView;
import edu.kit.iti.algo2.pse2013.walkaround.client.view.pullup.PullUpView;
import edu.kit.iti.algo2.pse2013.walkaround.shared.datastructures.DisplayCoordinate;
import edu.kit.iti.algo2.pse2013.walkaround.shared.datastructures.POI;
// Android Library
// Walkaround Library

/**
 *
 * This class is the main activity of the Walkaround app. This class organize
 * the whole view and shows the drawing map and route.
 *
 * @author Ludwig Biermann
 *
 */
<span class="nc" id="L49">public class MapView extends Activity {</span>

	/**
	 * Debug Information
	 */
<span class="nc" id="L54">	private static final String TAG_MAPVIEW = MapView.class.getSimpleName();</span>
<span class="nc" id="L55">	private static final String TAG_MAPVIEW_ANIMATION = TAG_MAPVIEW</span>
<span class="nc" id="L56">			+ &quot;_animation&quot;;</span>
<span class="nc" id="L57">	private static final String TAG_MAPVIEW_GESTURE = TAG_MAPVIEW + &quot;_gestures&quot;;</span>
<span class="nc" id="L58">	private static final String TAG_MAPVIEW_TOUCH = TAG_MAPVIEW + &quot;_touch&quot;;</span>

	/**
	 * Fling defaults
	 */
	private static final int USER_X_DELTA = 15;
	private static final int USER_Y_DELTA = 19;

	/**
	 * Default Pictures
	 */
	public static final int USER_ARROW_IMAGE = R.drawable.user_arrow;
	public static final int DEFAULT_PATTERN = R.drawable.fog;

	public static final int DEFAULT_FLAG = R.drawable.flag;
	public static final int DEFAULT_FLAG_ACTIVE = R.drawable.flag_activ;
	public static final int DEFAULT_FLAG_TARGET = R.drawable.flag_target;
	public static final int DEFAULT_FLAG_TARGET_ACTIVE = R.drawable.flag_target_activ;

	public static final int DEFAULT_WAYPOINT = R.drawable.waypoint;
	public static final int DEFAULT_WAYPOINT_ACTIVE = R.drawable.waypoint_activ;

<span class="nc" id="L80">	public static final int DEFAULT_POI = R.drawable.poi;</span>

	/**
	 * Default Drawables
	 */

	private Drawable flag;
	private Drawable flagActive;
	private Drawable flagTarget;
	private Drawable flagTargetActive;
	private Drawable waypoint;
	private Drawable waypointActive;
	private Drawable poi;
	// private Drawable poiActive;

	/**
	 * Views
	 */
	private ImageView map;
	private ImageView routeOverlay;
	private ImageView user;

	/**
	 * Controller
	 */
	private MapController mc;

	/**
	 * Animation
	 */
<span class="nc" id="L110">	private long startDelay = 0;</span>

	/**
	 * Gestik
	 */
	private GestureDetector gestureDetector;
	// private GestureOverlayView mapGest;

	/**
	 * Routen
	 */
	private ImageView currentActive;
	private RelativeLayout routeList;
	private RelativeLayout poiList;
	private float sizeOfPoints;
	// private int sizeOfRoute = 6;

	/**
	 *
	 */
	private PullUpView pullUp;

	private Point size;

	// private Canvas canvas;
	private Bitmap routeOverlayBitmap;

	@SuppressWarnings(&quot;unused&quot;)
	private float fromX;
	@SuppressWarnings(&quot;unused&quot;)
	private float fromY;

	/**
	 * User orientation
	 */
	@SuppressWarnings(&quot;unused&quot;)
	private float userX;
	@SuppressWarnings(&quot;unused&quot;)
	private float userY;
	@SuppressWarnings(&quot;unused&quot;)
	private float delta;

	private GestureDetector waypointGestureDetector;

	public Point getDisplaySize() {
<span class="nc" id="L155">		return size;</span>
	}


	public void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L160">		super.onCreate(savedInstanceState);</span>
<span class="nc" id="L161">		System.gc();</span>

<span class="nc" id="L163">		Log.d(TAG_MAPVIEW, &quot;Get Display size.&quot;);</span>

<span class="nc" id="L165">		Display display = this.getWindowManager().getDefaultDisplay();</span>
<span class="nc" id="L166">		size = new Point();</span>
<span class="nc" id="L167">		display.getSize(size);</span>

<span class="nc" id="L169">		routeOverlayBitmap = Bitmap.createBitmap(size.x, size.y,</span>
<span class="nc" id="L170">				Bitmap.Config.ARGB_8888);</span>
<span class="nc" id="L171">		routeOverlayBitmap.prepareToDraw();</span>

		// ---------------------------------------------
<span class="nc" id="L174">		Log.d(TAG_MAPVIEW, &quot;Initialisiere Layout.&quot;);</span>
<span class="nc" id="L175">		this.setContentView(R.layout.map);</span>

		// ---------------------------------------------
<span class="nc" id="L178">		Log.d(TAG_MAPVIEW, &quot;Initialisiere Drawables.&quot;);</span>
<span class="nc" id="L179">		flag = this.getResources().getDrawable(DEFAULT_FLAG);</span>
<span class="nc" id="L180">		flagActive = this.getResources().getDrawable(DEFAULT_FLAG_ACTIVE);</span>
<span class="nc" id="L181">		flagTarget = this.getResources().getDrawable(DEFAULT_FLAG_TARGET);</span>
<span class="nc" id="L182">		flagTargetActive = this.getResources().getDrawable(DEFAULT_FLAG_TARGET_ACTIVE);</span>
<span class="nc" id="L183">		waypoint = this.getResources().getDrawable(DEFAULT_WAYPOINT);</span>
<span class="nc" id="L184">		waypointActive = this.getResources().getDrawable(</span>
<span class="nc" id="L185">				DEFAULT_WAYPOINT_ACTIVE);</span>
<span class="nc" id="L186">		poi = this.getResources().getDrawable(DEFAULT_POI);</span>

		// ---------------------------------------------

<span class="nc" id="L190">		Log.d(TAG_MAPVIEW, &quot;DisplayMa√üe: &quot; + size.x + &quot; * &quot; + size.y);</span>

		// ---------------------------------------------
<span class="nc" id="L193">		Log.d(TAG_MAPVIEW, &quot;Initialisere Route und POI Ovetrlay.&quot;);</span>
<span class="nc" id="L194">		routeList = (RelativeLayout) this.findViewById(R.id.routeList);</span>
<span class="nc" id="L195">		poiList = (RelativeLayout) this.findViewById(R.id.poiList);</span>
<span class="nc" id="L196">		sizeOfPoints = (size.y / 10);</span>

		// ---------------------------------------------
<span class="nc" id="L199">		Log.d(TAG_MAPVIEW, &quot;Karte wird erstellt.&quot;);</span>
<span class="nc" id="L200">		map = (ImageView) this.findViewById(R.id.mapview_map);</span>
<span class="nc" id="L201">		map.setMinimumWidth(size.x);</span>
<span class="nc" id="L202">		map.setMinimumHeight(size.y);</span>
<span class="nc" id="L203">		map.setOnTouchListener(new MapTouchEventListener());</span>

		// ---------------------------------------------
<span class="nc" id="L206">		Log.d(TAG_MAPVIEW, &quot;User wird erstellt.&quot;);</span>
<span class="nc" id="L207">		user = (ImageView) this.findViewById(R.id.mapview_user);</span>
<span class="nc" id="L208">		user.setImageDrawable(this.getResources().getDrawable(USER_ARROW_IMAGE));</span>
<span class="nc" id="L209">		user.getLayoutParams().width = USER_X_DELTA * 4;</span>
<span class="nc" id="L210">		user.getLayoutParams().height = USER_Y_DELTA * 4;</span>
<span class="nc" id="L211">		user.setScaleType(ImageView.ScaleType.FIT_XY);</span>
<span class="nc" id="L212">		user.setOnTouchListener(new UserTouchEventListener());</span>

		// ---------------------------------------------
<span class="nc" id="L215">		Log.d(TAG_MAPVIEW, &quot;Initialisiere MapController.&quot;);</span>
<span class="nc" id="L216">		MapController.getInstance().startController(this);</span>
<span class="nc" id="L217">		mc = MapController.getInstance();</span>

		// ---------------------------------------------
<span class="nc" id="L220">		Log.d(TAG_MAPVIEW, &quot;Fragmente werden eingebaut&quot;);</span>
<span class="nc" id="L221">		FragmentTransaction ft = this.getFragmentManager().beginTransaction();</span>

		// ---------------------------------------------
<span class="nc" id="L224">		Log.d(TAG_MAPVIEW, &quot;Fragment PullUpMenue wird eingebaut&quot;);</span>
<span class="nc" id="L225">		this.pullUp = new PullUpView();</span>
<span class="nc" id="L226">		ft.add(R.id.pullUpMain, pullUp).commit();</span>

		// ---------------------------------------------
<span class="nc" id="L229">		Log.d(TAG_MAPVIEW, &quot;Fragment headUp wird eingebaut&quot;);</span>
<span class="nc" id="L230">		Fragment headUp = new HeadUpView();</span>
<span class="nc" id="L231">		ft.add(R.id.headupmain, headUp);</span>

		// -----------------------TEST---------------------
<span class="nc" id="L234">		Log.d(TAG_MAPVIEW, &quot;User wird in die Mitte gestellt.&quot;);</span>
		// this.setUserPositionOverlayImage(new DisplayCoordinate(
		// (float) size.x / 2, (float) size.y / 2), 180);

<span class="nc" id="L238">		routeOverlayBitmap = Bitmap.createBitmap(size.x, size.y,</span>
<span class="nc" id="L239">				Bitmap.Config.ARGB_8888);</span>
<span class="nc" id="L240">		routeOverlayBitmap.prepareToDraw();</span>

<span class="nc" id="L242">		gestureDetector = new GestureDetector(this, new MapGestureDetector());</span>
<span class="nc" id="L243">		waypointGestureDetector = new GestureDetector(this,</span>
<span class="nc" id="L244">				new WaypointGestureDetector());</span>

		// this.setUserPositionOverlayImage(size.x / 2, size.y / 2);
<span class="nc" id="L247">	}</span>

	/**
	 * gives the pullupview back
	 */
	public PullUpView getPullUpView() {
<span class="nc" id="L253">		return pullUp;</span>
	}

	/**
	 * Updates the map
	 *
	 * @param b
	 *            the new map bitmap
	 */
	public void updateMapImage(final Bitmap b) {

<span class="nc" id="L264">		runOnUiThread(new Runnable() {</span>
			public void run() {
<span class="nc bnc" id="L266" title="All 2 branches missed.">				if (!b.isRecycled()) {</span>
					try {
<span class="nc" id="L268">						map.setImageBitmap(b);</span>
<span class="nc" id="L269">						map.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L270">					} catch (IllegalArgumentException e) {</span>
<span class="nc" id="L271">						Log.e(TAG_MAPVIEW, &quot;&quot; + e.toString());</span>
					}
				}
<span class="nc" id="L274">			}</span>
		});
<span class="nc" id="L276">	}</span>

	/**
	 * updates the route
	 *
	 * @param b
	 *            the new route bitmap
	 */
	public void updateRouteOverlayImage(final Bitmap b) {

<span class="nc bnc" id="L286" title="All 2 branches missed.">		if (routeOverlay == null) {</span>
<span class="nc" id="L287">			routeOverlay = (ImageView) findViewById(R.id.mapview_overlay);</span>
		}
<span class="nc" id="L289">		runOnUiThread(new Runnable() {</span>
			public void run() {
<span class="nc bnc" id="L291" title="All 2 branches missed.">				if (!b.isRecycled()) {</span>
					try {
<span class="nc" id="L293">						routeOverlay.setImageBitmap(b);</span>
<span class="nc" id="L294">						routeOverlay.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L295">					} catch (IllegalArgumentException e) {</span>
<span class="nc" id="L296">						Log.e(TAG_MAPVIEW, &quot;&quot; + e.toString());</span>
					}
				}

<span class="nc" id="L300">			}</span>
		});
<span class="nc" id="L302">	}</span>

	/*
	 *
	 *
	 * @param dip
	 *
	 * @return
	 *
	 * public int dipToPixel(float dip) { return (int)
	 * (getResources().getDisplayMetrics().density * dip); }
	 *
	 * public float pixelToDip(int p) { return (p /
	 * getResources().getDisplayMetrics().density); }
	 */

	/**
	 * Change the position and the orientation of the user
	 *
	 * @param delta
	 *            degree of the neew rotation
	 */
	public void onPositionChange(final float x, final float y,
			final float deltaDegree) {
<span class="nc" id="L326">		runOnUiThread(new Runnable() {</span>
			public void run() {
<span class="nc" id="L328">				delta = deltaDegree;</span>
<span class="nc" id="L329">				userX = x;</span>
<span class="nc" id="L330">				userY = y;</span>
<span class="nc" id="L331">			}</span>
		});
		// this.setUserPositionOverlayImage(new DisplayCoordinate(userX, userY),
		// this.delta);
<span class="nc" id="L335">	}</span>

	/**
	 * updates the DisplayWaypoints
	 *
	 * @param displayPoints
	 *            the new DisplayWaypoints
	 */
	public void updateDisplayWaypoints(final List&lt;DisplayWaypoint&gt; displayPoints) {

<span class="nc" id="L345">		final Context context = this;</span>

<span class="nc bnc" id="L347" title="All 2 branches missed.">		if (displayPoints.size() == 0) {</span>

<span class="nc" id="L349">			runOnUiThread(new Runnable() {</span>
				public void run() {
<span class="nc" id="L351">					currentActive = null;</span>
<span class="nc" id="L352">					routeList.removeAllViews();</span>
<span class="nc" id="L353">				}</span>
			});

<span class="nc" id="L356">		} else {</span>

<span class="nc" id="L358">			runOnUiThread(new Runnable() {</span>
				public void run() {

<span class="nc" id="L361">					Log.d(&quot;red&quot;, &quot;&quot;+displayPoints.size());</span>

<span class="nc" id="L363">					currentActive = null;</span>
<span class="nc" id="L364">					routeList.removeAllViews();</span>

<span class="nc" id="L366">					fromX = displayPoints.get(0).getX();</span>
<span class="nc" id="L367">					fromY = displayPoints.get(0).getY();</span>

<span class="nc bnc" id="L369" title="All 2 branches missed.">					for (DisplayWaypoint dw : displayPoints) {</span>

<span class="nc" id="L371">						ImageView iv = new ImageView(context);</span>
<span class="nc" id="L372">						iv.setY(dw.getY() - 145);</span>
<span class="nc" id="L373">						iv.setX(dw.getX() - 75);</span>

<span class="nc" id="L375">						iv.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L376">						iv.setLayoutParams(new LayoutParams((int) sizeOfPoints, (int) sizeOfPoints));</span>
<span class="nc" id="L377">						iv.setScaleType(ImageView.ScaleType.FIT_XY);</span>
<span class="nc" id="L378">						iv.setTag(dw.getId());</span>
<span class="nc" id="L379">						iv.setOnTouchListener(new WaypointTouchListener(iv, dw.getId()));</span>
<span class="nc" id="L380">						iv.setImageDrawable(waypoint);</span>
<span class="nc" id="L381">						routeList.addView(iv);</span>
					}

<span class="nc bnc" id="L384" title="All 2 branches missed.">					if (routeList.getChildCount() &gt; 0) {</span>

<span class="nc" id="L386">						ImageView iv = (ImageView) routeList</span>
<span class="nc" id="L387">								.getChildAt((routeList.getChildCount() - 1));</span>
<span class="nc" id="L388">						iv.setImageDrawable(flagTarget);</span>
						// iv.setX(iv.getX() - (sizeOfPoints / 2));

<span class="nc" id="L391">						iv = (ImageView) routeList.getChildAt(0);</span>
<span class="nc" id="L392">						iv.setImageDrawable(flag);</span>

						// if ((routeList.getChildCount() != 1)) {
						// iv.setX(iv.getX() - (sizeOfPoints / 2));
						// }
					}
<span class="nc" id="L398">				}</span>
			});
		}
<span class="nc" id="L401">	}</span>

	/**
	 * updates the POI¬¥s on the Display
	 *
	 * @param dp
	 *            List of pois
	 */
	public void updateDisplayCoordinate(final List&lt;DisplayPOI&gt; dp) {
<span class="nc" id="L410">		poiList.removeAllViews();</span>
<span class="nc" id="L411">		final Context context = this;</span>

<span class="nc" id="L413">		runOnUiThread(new Runnable() {</span>
			public void run() {
<span class="nc bnc" id="L415" title="All 2 branches missed.">				for (DisplayPOI value : dp) {</span>
<span class="nc" id="L416">					ImageView iv = new ImageView(context);</span>
<span class="nc" id="L417">					iv.setImageDrawable(poi);</span>
<span class="nc" id="L418">					iv.setY(value.getY());</span>
<span class="nc" id="L419">					iv.setX(value.getX());</span>
<span class="nc" id="L420">					iv.setTag(value.getId());</span>
<span class="nc" id="L421">					iv.setLayoutParams(new LayoutParams((int) sizeOfPoints,</span>
<span class="nc" id="L422">							(int) sizeOfPoints));</span>
<span class="nc" id="L423">					iv.setScaleType(ImageView.ScaleType.FIT_XY);</span>
<span class="nc" id="L424">					iv.setOnTouchListener(new POITouchListener(iv, value</span>
<span class="nc" id="L425">							.getId()));</span>
<span class="nc" id="L426">					poiList.addView(iv);</span>
				}
<span class="nc" id="L428">			}</span>
		});
<span class="nc" id="L430">	}</span>

	/**
	 * Set an new Waypoint as active
	 *
	 * @param id
	 *            the id of the waypoint
	 */
	public void setActiveWaypoint(final int id) {
<span class="nc" id="L439">		runOnUiThread(new Runnable() {</span>
			public void run() {

<span class="nc bnc" id="L442" title="All 2 branches missed.">				if (currentActive != null) {</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">					if (currentActive.getDrawable().equals(flagActive)) {</span>
<span class="nc" id="L444">						currentActive.setImageDrawable(flag);</span>

					}

<span class="nc bnc" id="L448" title="All 2 branches missed.">					if (currentActive.getDrawable().equals(flagTargetActive)) {</span>
<span class="nc" id="L449">						currentActive.setImageDrawable(flagTarget);</span>

					}

<span class="nc bnc" id="L453" title="All 2 branches missed.">					if (currentActive.getDrawable().equals(waypointActive)) {</span>
<span class="nc" id="L454">						currentActive.setImageDrawable(waypoint);</span>

					}
				}

<span class="nc" id="L459">				boolean found = false;</span>

<span class="nc bnc" id="L461" title="All 4 branches missed.">				for (int a = 0; a &lt; routeList.getChildCount() &amp;&amp; !found; a++) {</span>
<span class="nc" id="L462">					int valueId = Integer.parseInt(routeList.getChildAt(a).getTag()</span>
<span class="nc" id="L463">							.toString());</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">					if (valueId == id) {</span>
<span class="nc" id="L465">						currentActive = (ImageView) routeList.getChildAt(a);</span>

<span class="nc bnc" id="L467" title="All 2 branches missed.">						if (currentActive.getDrawable().equals(flag)) {</span>
<span class="nc" id="L468">							currentActive.setImageDrawable(flagActive);</span>
						}

<span class="nc bnc" id="L471" title="All 2 branches missed.">						if (currentActive.getDrawable().equals(flagTarget)) {</span>
<span class="nc" id="L472">							currentActive.setImageDrawable(flagTargetActive);</span>
						}

<span class="nc bnc" id="L475" title="All 2 branches missed.">						if (currentActive.getDrawable().equals(waypoint)) {</span>
<span class="nc" id="L476">							currentActive.setImageDrawable(waypointActive);</span>
						}
<span class="nc" id="L478">						found = true;</span>
					}
				}
<span class="nc" id="L481">			}</span>
		});

<span class="nc" id="L484">	}</span>

	/**
	 * shift the User Position arrow to an new position
	 *
	 */
	public void setUserPositionOverlayImage(final float x, final float y) {
<span class="nc" id="L491">		runOnUiThread(new Runnable() {</span>
			public void run() {
				//TODO User Pos mitten
<span class="nc" id="L494">				user.setX(x);</span>
<span class="nc" id="L495">				user.setY(y);</span>
<span class="nc" id="L496">			}</span>
		});
<span class="nc" id="L498">	}</span>

	/**
	 * shift the User Position arrow to an new position
	 *
	 * @param coor
	 *            target coordinates
	 * @param degree
	 *            rotation
	 */
	public void setUserPositionOverlayImage(final float degree) {
<span class="nc" id="L509">		runOnUiThread(new Runnable() {</span>
			public void run() {
<span class="nc" id="L511">				user.setRotation(degree);</span>
<span class="nc" id="L512">			}</span>
		});
<span class="nc" id="L514">	}</span>

	/**
	 * shift the User Position arrow to an new position
	 *
	 * @param coor
	 *            target coordinates
	 * @param degree
	 *            rotation
	 */
	@SuppressWarnings(&quot;unused&quot;)
	private void setUserPositionOverlayImage(DisplayCoordinate coor,
			float degree) {
		// TODO duration √ºberdenken
<span class="nc" id="L528">		AnimatorSet set = new AnimatorSet();</span>
<span class="nc" id="L529">		this.userX = coor.getX();</span>
<span class="nc" id="L530">		this.userY = coor.getY();</span>

<span class="nc" id="L532">		Log.d(TAG_MAPVIEW, &quot;Thread Animator Set UP&quot;);</span>

<span class="nc" id="L534">		ObjectAnimator transX = ObjectAnimator.ofFloat(user, &quot;x&quot;, coor.getX()</span>
<span class="nc" id="L535">				- USER_X_DELTA);</span>
<span class="nc" id="L536">		ObjectAnimator transY = ObjectAnimator.ofFloat(user, &quot;y&quot;, coor.getY()</span>
<span class="nc" id="L537">				- USER_Y_DELTA);</span>
<span class="nc" id="L538">		ObjectAnimator rotate = ObjectAnimator</span>
<span class="nc" id="L539">				.ofFloat(user, &quot;rotation&quot;, degree);</span>

<span class="nc" id="L541">		transX.setDuration(1000);</span>
<span class="nc" id="L542">		transY.setDuration(1000);</span>
<span class="nc" id="L543">		rotate.setDuration(1000);</span>

<span class="nc" id="L545">		set.play(transX).with(transY);</span>
<span class="nc" id="L546">		set.play(transY).with(rotate);</span>
<span class="nc" id="L547">		set.play(transX).with(rotate);</span>

<span class="nc" id="L549">		set.addListener(new UserAnimationListener(coor, degree));</span>

<span class="nc" id="L551">		set.setStartDelay(startDelay);</span>
<span class="nc" id="L552">		startDelay += 1000;</span>
<span class="nc" id="L553">		set.start();</span>

<span class="nc" id="L555">	}</span>

	// ----------------Animation Listener ---------------------

	/**
	 * A Listener who listen to the user position animation
	 *
	 * @author Ludwig Biermann
	 *
	 */
	private class UserAnimationListener implements AnimatorListener {

		private float degree;
		private DisplayCoordinate coor;

<span class="nc" id="L570">		public UserAnimationListener(DisplayCoordinate coor, float degree) {</span>
<span class="nc" id="L571">			this.degree = degree;</span>
<span class="nc" id="L572">			this.coor = coor;</span>
<span class="nc" id="L573">		}</span>


		public void onAnimationCancel(Animator animation) {
<span class="nc" id="L577">			Log.d(TAG_MAPVIEW_ANIMATION, &quot;Animation Cancel&quot;);</span>
<span class="nc" id="L578">		}</span>


		public void onAnimationEnd(Animator animation) {
<span class="nc" id="L582">			user.clearAnimation();</span>
<span class="nc" id="L583">			startDelay -= 1000;</span>

<span class="nc" id="L585">			user.setX(coor.getX() - USER_X_DELTA);</span>
<span class="nc" id="L586">			user.setY(coor.getY() - USER_Y_DELTA);</span>

<span class="nc" id="L588">			user.setRotation(degree);</span>
<span class="nc" id="L589">			Log.d(TAG_MAPVIEW_ANIMATION, &quot;Drehe den User um &quot; + degree</span>
<span class="nc" id="L590">					+ &quot; Grad&quot;);</span>
<span class="nc" id="L591">		}</span>


		public void onAnimationRepeat(Animator animation) {
<span class="nc" id="L595">			Log.d(TAG_MAPVIEW_ANIMATION, &quot;Animation Repeat&quot;);</span>

<span class="nc" id="L597">		}</span>


		public void onAnimationStart(Animator animation) {
<span class="nc" id="L601">			Log.d(TAG_MAPVIEW_ANIMATION, &quot;Animation Start&quot;);</span>
<span class="nc" id="L602">		}</span>

	}

	// ----------------Touch Listener ---------------------

	/**
	 * This is a Gesture Detector which listen to the map touches.
	 *
	 * @author Ludwig Biermann
	 *
	 */
	private class MapGestureDetector implements OnGestureListener {

		@SuppressWarnings(&quot;unused&quot;)
		float oldX;
		@SuppressWarnings(&quot;unused&quot;)
		float oldY;
		float gesamt;

<span class="nc" id="L622">		public MapGestureDetector() {</span>
<span class="nc" id="L623">			oldX = 0.0F;</span>
<span class="nc" id="L624">			oldY = 0.0F;</span>
<span class="nc" id="L625">		}</span>

		public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX,
				float velocityY) {
<span class="nc" id="L629">			Log.d(TAG_MAPVIEW_GESTURE, &quot;MapTouch Fling&quot;);</span>
<span class="nc" id="L630">			return false;</span>
		}

		public boolean onScroll(MotionEvent e1, MotionEvent e2,
				float distanceX, float distanceY) {
<span class="nc" id="L635">			Log.d(TAG_MAPVIEW_GESTURE, &quot;SCROLL EVENT&quot;);</span>

<span class="nc bnc" id="L637" title="All 2 branches missed.">			if (e2.getPointerCount() &gt;= 2) {</span>

<span class="nc" id="L639">				float x = Math.abs(e2.getX(0) - e2.getX(1));</span>
<span class="nc" id="L640">				float y = Math.abs(e2.getY(0) - e2.getY(1));</span>

<span class="nc bnc" id="L642" title="All 2 branches missed.">				if (e2.getX(0) &lt; e2.getX(1)) {</span>
<span class="nc" id="L643">					x += e2.getX(0);</span>
<span class="nc" id="L644">				} else {</span>
<span class="nc" id="L645">					x += e2.getX(1);</span>
				}

<span class="nc bnc" id="L648" title="All 2 branches missed.">				if (e2.getY(0) &lt; e2.getY(1)) {</span>
<span class="nc" id="L649">					x += e2.getY(0);</span>
<span class="nc" id="L650">				} else {</span>
<span class="nc" id="L651">					x += e2.getY(1);</span>
				}
<span class="nc" id="L653">				int twoFingerZoomOffset = 1000;</span>

<span class="nc" id="L655">				float z = ((Math.abs(distanceY) + Math.abs(distanceX)) / twoFingerZoomOffset);</span>

<span class="nc" id="L657">				float diff = (float) Math.sqrt(Math.pow(</span>
<span class="nc" id="L658">						(double) Math.abs(e2.getX(0) - e2.getX(1)), 2)</span>
<span class="nc" id="L659">						* Math.pow((double) Math.abs(e2.getY(1) - e2.getY(1)),</span>
<span class="nc" id="L660">								2));</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">				if (diff &lt; gesamt) {</span>
<span class="nc" id="L662">					mc.onZoom(z, new DisplayCoordinate(x, y));</span>
<span class="nc" id="L663">				} else {</span>
<span class="nc" id="L664">					mc.onZoom(-z, new DisplayCoordinate(x, y));</span>
				}
<span class="nc" id="L666">			} else {</span>

<span class="nc" id="L668">				Log.d(TAG_MAPVIEW_GESTURE, &quot;MapTouch Scroll&quot;);</span>
				// distanceY *= -1;
<span class="nc bnc" id="L670" title="All 2 branches missed.">				if (e1.getY() &gt; e2.getY()) {</span>
<span class="nc" id="L671">					Log.d(TAG_MAPVIEW_GESTURE, &quot;Up &quot; + distanceY);</span>
<span class="nc" id="L672">				} else {</span>
<span class="nc" id="L673">					Log.d(TAG_MAPVIEW_GESTURE, &quot;Down &quot; + -distanceY);</span>
				}

<span class="nc bnc" id="L676" title="All 2 branches missed.">				if (e1.getX() &gt; e2.getX()) {</span>
<span class="nc" id="L677">					Log.d(TAG_MAPVIEW_GESTURE, &quot;Left &quot; + distanceX);</span>
<span class="nc" id="L678">				} else {</span>
<span class="nc" id="L679">					Log.d(TAG_MAPVIEW_GESTURE, &quot;Right &quot; + -distanceX);</span>
				}

<span class="nc" id="L682">				mc.onShift(distanceX, distanceY);</span>
			}
<span class="nc" id="L684">			return true;</span>
		}

		public void onLongPress(MotionEvent event) {
<span class="nc" id="L688">			Log.d(TAG_MAPVIEW_GESTURE, &quot;MapTouch Long Touch&quot;);</span>
<span class="nc" id="L689">			mc.onCreatePoint(new DisplayCoordinate(event.getX(), event.getY()));</span>
<span class="nc" id="L690">		}</span>

		public boolean onDown(MotionEvent e) {
<span class="nc" id="L693">			Log.d(TAG_MAPVIEW_GESTURE, &quot;MapTouch Down&quot;);</span>
<span class="nc" id="L694">			this.oldX = e.getX();</span>
<span class="nc" id="L695">			this.oldY = e.getY();</span>
<span class="nc" id="L696">			return false;</span>
		}

		public void onShowPress(MotionEvent e) {
<span class="nc" id="L700">			Log.d(TAG_MAPVIEW_GESTURE, &quot;MapTouch Show Press&quot;);</span>
<span class="nc" id="L701">		}</span>

		public boolean onSingleTapUp(MotionEvent e) {
<span class="nc" id="L704">			Log.d(TAG_MAPVIEW_GESTURE, &quot;MapTouch TapUp&quot;);</span>
<span class="nc" id="L705">			return false;</span>
		}

	}

	/**
	 * This class forwards the touch events to the gesture detector
	 *
	 * @author Ludwig Biermann
	 *
	 */
<span class="nc" id="L716">	private class MapTouchEventListener implements OnTouchListener {</span>

		public boolean onTouch(View view, MotionEvent event) {
<span class="nc bnc" id="L719" title="All 2 branches missed.">			if (map.equals(view)) {</span>
<span class="nc" id="L720">				Log.d(TAG_MAPVIEW_TOUCH, &quot;TOUCH!&quot; + view.toString());</span>
<span class="nc" id="L721">				gestureDetector.onTouchEvent(event);</span>
<span class="nc" id="L722">				return true;</span>
			}

<span class="nc" id="L725">			return false;</span>
		}

	}

	/**
	 * This class intercept the touch events on the user arrow
	 *
	 * @author Ludwig Biermann
	 *
	 */
<span class="nc" id="L736">	private class UserTouchEventListener implements OnTouchListener {</span>
		public boolean onTouch(View arg0, MotionEvent arg1) {
<span class="nc bnc" id="L738" title="All 2 branches missed.">			if (arg0.equals(user)) {</span>
<span class="nc" id="L739">				Log.d(TAG_MAPVIEW_TOUCH, &quot;UserTouch on User Arrow&quot;);</span>
<span class="nc" id="L740">				return true;</span>
			}
<span class="nc" id="L742">			return false;</span>
		}
	}

	/**
	 * This Class intercept the touch to waypoints
	 *
	 * @author Ludwig Biermann
	 *
	 */
	private class WaypointTouchListener implements OnTouchListener {

		private ImageView iv;
		private int id;

		/**
		 * Create a new Waypoint
		 *
		 * @param iv
		 *            the new Imageview
		 */
<span class="nc" id="L763">		WaypointTouchListener(ImageView iv, int id) {</span>
<span class="nc" id="L764">			this.iv = iv;</span>
<span class="nc" id="L765">			this.id = id;</span>
<span class="nc" id="L766">		}</span>

		public boolean onTouch(View view, MotionEvent event) {
<span class="nc bnc" id="L769" title="All 2 branches missed.">			if (view.equals(iv)) {</span>
<span class="nc" id="L770">				Log.d(TAG_MAPVIEW_TOUCH, &quot;UserTouch auf View ID:&quot; + id);</span>
<span class="nc" id="L771">				currentId = id;</span>
<span class="nc" id="L772">				currentView = iv;</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">				if (waypointGestureDetector.onTouchEvent(event)) {</span>
<span class="nc" id="L774">	                return true;</span>
	            }

<span class="nc bnc" id="L777" title="All 2 branches missed.">				if(event.getAction() == MotionEvent.ACTION_UP){</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">					if(mIsScrolling){</span>
<span class="nc" id="L779">					Log.d(&quot;fuck&quot;, &quot;Action Up&quot;);</span>
<span class="nc" id="L780">                    mIsScrolling  = false;</span>
<span class="nc" id="L781">                    mIsScrolling = false;</span>
<span class="nc" id="L782">					mc.pushMovedWaypoint();</span>
					}
				}

			}
<span class="nc" id="L787">			return false;</span>
		}
	}

	private int currentId;
	private POI currentPOI;
	private ImageView currentView;
	private boolean mIsScrolling;

	/**
	 * This is a Gesture Detector which listen to the Waypoint touches.
	 *
	 * @author Ludwig Biermann
	 *
	 */
<span class="nc" id="L802">	private class WaypointGestureDetector implements OnGestureListener {</span>
		public boolean onDown(MotionEvent event) {
<span class="nc" id="L804">			Log.d(TAG_MAPVIEW_GESTURE, &quot;Waypoint onDown &quot; + currentId);</span>
<span class="nc" id="L805">			mc.setActive(currentId);</span>
			// mc.getActiveWaypointId();
<span class="nc" id="L807">			return true;</span>
		}
		public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY) {

<span class="nc" id="L811">			Log.d(TAG_MAPVIEW_GESTURE, &quot;Fling! &quot; + velocityY + &quot; &quot; + e2.getY()</span>
<span class="nc" id="L812">					+ &quot; &quot; + currentId);</span>

<span class="nc" id="L814">			float velocity = (float) Math.sqrt((double) Math.pow(</span>
<span class="nc" id="L815">					Math.abs(velocityX), 2)</span>
<span class="nc" id="L816">					+ (double) Math.pow(Math.abs(velocityY), 2));</span>

<span class="nc bnc" id="L818" title="All 2 branches missed.">			if (velocity &gt; 400) {</span>
<span class="nc" id="L819">				Log.d(TAG_MAPVIEW_GESTURE, &quot;Delete Point &quot; + currentId);</span>
<span class="nc" id="L820">				mc.onDeletePoint(currentId);</span>
			}

<span class="nc" id="L823">			return false;</span>
		}

		public void onLongPress(MotionEvent event) {
<span class="nc" id="L827">			Log.d(TAG_MAPVIEW_GESTURE, &quot;Waypoint onLongPress &quot; + currentId);</span>
<span class="nc" id="L828">		}</span>

		public boolean onScroll(MotionEvent event1, MotionEvent event2,
				float deltaX, float deltaY) {
<span class="nc" id="L832">			Log.d(TAG_MAPVIEW_GESTURE, &quot;Waypoint onScroll &quot; + currentId);</span>

			//routeList.removeView(currentView);
<span class="nc" id="L835">			currentView.setX(currentView.getX() - deltaX);</span>
<span class="nc" id="L836">			currentView.setY(currentView.getY() - deltaY);</span>
<span class="nc" id="L837">			mc.onMovePoint(-deltaX, -deltaY, currentId);</span>
			//routeList.addView(currentView);
<span class="nc" id="L839">			mIsScrolling = true;</span>

<span class="nc" id="L841">			return true;</span>
		}

		public void onShowPress(MotionEvent arg0) {
<span class="nc" id="L845">			Log.d(TAG_MAPVIEW_GESTURE, &quot;Waypoint onShowPress &quot; + currentId);</span>

<span class="nc" id="L847">		}</span>

		public boolean onSingleTapUp(MotionEvent arg0) {
<span class="nc" id="L850">			Log.d(TAG_MAPVIEW_GESTURE, &quot;Waypoint onSingleTapUp &quot; + currentId);</span>
<span class="nc" id="L851">			return false;</span>
		}

	}

	/**
	 * This Class intercept the touch to waypoints
	 *
	 * @author Ludwig Biermann
	 *
	 */
	private class POITouchListener implements OnTouchListener {

		private ImageView iv;
		private int id;

		/**
		 * Create a new POITouchListener
		 *
		 * @param iv
		 *            the new Imageview
		 */
<span class="nc" id="L873">		POITouchListener(ImageView iv, int id) {</span>
<span class="nc" id="L874">			this.iv = iv;</span>
<span class="nc" id="L875">			this.id = id;</span>
<span class="nc" id="L876">		}</span>

		public boolean onTouch(View view, MotionEvent event) {
<span class="nc bnc" id="L879" title="All 2 branches missed.">			if (view.equals(iv)) {</span>
<span class="nc" id="L880">				Log.d(TAG_MAPVIEW_TOUCH, &quot;UserTouch auf POI ID:&quot; + id);</span>
<span class="nc" id="L881">				currentPOI = mc.getPOIById(id);</span>
<span class="nc" id="L882">				pullUp.changeView(PullUpView.CONTENT_INFO);</span>
<span class="nc" id="L883">				pullUp.setFullSizeHeight();</span>
			}
<span class="nc" id="L885">			return false;</span>
		}
	}


	public void onLowMemory() {
<span class="nc" id="L891">		super.onLowMemory();</span>
<span class="nc" id="L892">		System.gc();</span>
<span class="nc" id="L893">	}</span>

	public POI getCurrentPOI() {
<span class="nc" id="L896">		return currentPOI;</span>
	}

	public void onCreateView() {
<span class="nc" id="L900">		super.onDestroy();</span>
<span class="nc" id="L901">		Log.d(TAG_MAPVIEW, &quot;Create View MapView&quot;);</span>
<span class="nc" id="L902">	}</span>

	public void onDestroyView() {
<span class="nc" id="L905">		super.onDestroy();</span>
<span class="nc" id="L906">		Log.d(TAG_MAPVIEW, &quot;Destroy View MapView&quot;);</span>
<span class="nc" id="L907">	}</span>


	public void onDestroy() {
<span class="nc" id="L911">		super.onDestroy();</span>
<span class="nc" id="L912">		TextToSpeechUtility.getInstance().shutdown();</span>
<span class="nc" id="L913">		Log.d(TAG_MAPVIEW, &quot;Destroy MapView&quot;);</span>
<span class="nc" id="L914">	}</span>


	public void onBackPressed() {
<span class="nc" id="L918">		MapController.getInstance().getPullUpView().setNullSizeHeight();</span>
<span class="nc" id="L919">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span>walkaround-tests (16.08.2013 02:31:21)</div></body></html>